generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  AUTHOR
  REVIEWER
  EDITOR
  ADMIN
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  REVISION_REQUESTED
  ACCEPTED
  REJECTED
  PUBLISHED
}

// Models

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?   // Hashed password
  role          UserRole  @default(AUTHOR)
  affiliation   String?
  phone         String?
  emailVerified DateTime?
  image         String?
  
  accounts      Account[]
  sessions      Session[]
  submissions   Submission[]
  reviews       Review[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Submission {
  id          String           @id @default(cuid())
  title       String
  abstract    String           @db.Text
  keywords    String?          // Comma separated
  fileUrl     String?          // Path to PDF
  status      SubmissionStatus @default(DRAFT)
  
  authorId    String
  author      User             @relation(fields: [authorId], references: [id])
  
  coAuthors   String?          // JSON string or simple text for now
  displayAuthor String?        // For manual uploads (overrides author.name)
  displayAffiliation String?   // For manual uploads
  publishedAt DateTime?        // For backdating or manual publication date
  
  // New manual upload fields
  manualIssueText String?      @db.Text // Manual issue description (replacing relation)
  references      String?      @db.Text // Bullet points of references
  otherAuthors    Json?        // [{name, affiliation}]
  manualKeywords  String[]     // Array of keywords
  
  issueId     String?
  issue       Issue?           @relation(fields: [issueId], references: [id])
  
  reviews     Review[]
  history     SubmissionHistory[]
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Issue {
  id          String       @id @default(cuid())
  volume      Int
  number      Int
  year        Int
  title       String?      // Optional thematic title
  isPublished Boolean      @default(false)
  coverImage  String?
  
  submissions Submission[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([volume, number])
}

model SubmissionHistory {
  id           String           @id @default(cuid())
  submissionId String
  submission   Submission       @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  status       SubmissionStatus
  comment      String?
  changedBy    String?          // User ID or "System"
  
  createdAt    DateTime         @default(now())
}

model Review {
  id           String   @id @default(cuid())
  submissionId String
  reviewerId   String
  
  score        Int?
  feedback     String?  @db.Text
  recommendation String? // ACCEPT, REJECT, REVISION
  
  submission   Submission @relation(fields: [submissionId], references: [id])
  reviewer     User       @relation(fields: [reviewerId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
